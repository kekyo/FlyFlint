<!--
////////////////////////////////////////////////////////////////////////////
//
// Lightweight static O/R mapping builder at compile time.
// Copyright (c) Kouji Matsui (@kozy_kekyo, @kekyo2)
//
// Licensed under Apache-v2: https://opensource.org/licenses/Apache-2.0
//
////////////////////////////////////////////////////////////////////////////
-->
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    
  <!-- Common -->
    
  <PropertyGroup>
    <FlyFlintBuildEnable Condition="'$(FlyFlintBuildEnable)' == ''">True</FlyFlintBuildEnable>
    <FlyFlintBuildTrace Condition="'$(FlyFlintBuildTrace)' == ''">False</FlyFlintBuildTrace>
  </PropertyGroup>

  <!-- Common (internal) -->
    
  <PropertyGroup Condition="('$(MSBuildRuntimeType)' == 'Core') AND ('$(MicrosoftNETBuildTasksTFM)' != '')">
    <_FFB_PlatformName>$(MicrosoftNETBuildTasksTFM)</_FFB_PlatformName>
  </PropertyGroup>
  <PropertyGroup Condition="('$(MSBuildRuntimeType)' == 'Core') AND ('$(MicrosoftNETBuildTasksTFM)' == '') AND ('$(BundledNETCoreAppTargetFrameworkVersion)' != '')">
    <_FFB_PlatformName Condition="$(BundledNETCoreAppTargetFrameworkVersion) &gt;= 5.0">net$(BundledNETCoreAppTargetFrameworkVersion)</_FFB_PlatformName>
    <_FFB_PlatformName Condition="$(BundledNETCoreAppTargetFrameworkVersion) &lt; 5.0">netcoreapp$(BundledNETCoreAppTargetFrameworkVersion)</_FFB_PlatformName>
  </PropertyGroup>
  <PropertyGroup Condition="('$(MSBuildRuntimeType)' == 'Core') AND ('$(MicrosoftNETBuildTasksTFM)' == '') AND ('$(BundledNETCoreAppTargetFrameworkVersion)' == '')">
    <_FFB_PlatformName>netcoreapp2.0</_FFB_PlatformName>
  </PropertyGroup>
  <PropertyGroup Condition="'$(MSBuildRuntimeType)' != 'Core'">
    <_FFB_PlatformName>net45</_FFB_PlatformName>
  </PropertyGroup>

  <PropertyGroup>
    <_FFB_ToolingDir>$([System.IO.Path]::Combine('$(_FFB_ScriptBaseDir)','..','tools','$(_FFB_PlatformName)'))</_FFB_ToolingDir>
  </PropertyGroup>

  <!-- Custom inlined task -->
    
  <UsingTask
    TaskName="GetCombinedReferencesBasePath"
    TaskFactory="RoslynCodeTaskFactory"
    AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
    <ParameterGroup>
      <References ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <CombinedReferencesBasePath Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System"/>
      <Using Namespace="System.IO"/>
      <!-- HACK: Will cause compilation error by using `System.Collection.Generic` and/or `System.Linq` on MacOS
           (Maybe related both mono environment and unreferenced core assembly on `RoslynCodeTaskFactory`) -->
      <Using Namespace="System.Collections"/>
      <Using Namespace="Microsoft.Build.Framework"/>
      <Code Type="Fragment" Language="cs">
<![CDATA[
        var candidates = new Hashtable();
        foreach (var item in References)
        {
            if (!string.IsNullOrEmpty(item.ItemSpec))
            {
                var path = Path.GetDirectoryName(Path.GetFullPath(item.ItemSpec));
                candidates[path] = path;
            }
        }
        var pathList = new object[candidates.Keys.Count];
        candidates.Keys.CopyTo(pathList, 0);
        CombinedReferencesBasePath = string.Join(";", pathList);
]]>
      </Code>
    </Task>
  </UsingTask>
    
  <!-- Custom target at after compile process -->
    
  <Target Name="FlyFlintBuild" AfterTargets="AfterCompile"
    Condition="'$(FlyFlintBuildEnable)' == 'True'">
      
    <PropertyGroup>
      <FlyFlintBuildToolingRuntimeName Condition="'$(FlyFlintBuildToolingRuntimeName)' == ''">$(_FFB_RuntimeName)</FlyFlintBuildToolingRuntimeName>
      <FlyFlintBuildToolingDir Condition="'$(FlyFlintBuildToolingDir)' == ''">$([System.IO.Path]::GetFullPath('$(_FFB_ToolingDir)'))</FlyFlintBuildToolingDir>
      <FlyFlintBuildToolingPath Condition="'$(FlyFlintBuildToolingPath)' == ''">$([System.IO.Path]::Combine('$(FlyFlintBuildToolingDir)','$(_FFB_ExecutableName)'))</FlyFlintBuildToolingPath>
      <FlyFlintBuildTraceOption Condition="$(FlyFlintBuildTrace)">-t</FlyFlintBuildTraceOption>
      <FlyFlintBuildTraceOption Condition="'$(FlyFlintBuildTraceOption)' == ''"></FlyFlintBuildTraceOption>
    </PropertyGroup>

    <GetCombinedReferencesBasePath References="@(ReferencePath)">
      <Output TaskParameter="CombinedReferencesBasePath" PropertyName="CombinedReferencesBasePath" />
    </GetCombinedReferencesBasePath>
        
    <Exec WorkingDirectory="$(FlyFlintBuildToolingDir)"
        Command="$(FlyFlintBuildToolingRuntimeName)&quot;$(FlyFlintBuildToolingPath)&quot; $(FlyFlintBuildTraceOption) &quot;$(CombinedReferencesBasePath)&quot; &quot;$(ProjectDir)$(IntermediateOutputPath)$(TargetFileName)&quot;" />
  </Target>

</Project>
